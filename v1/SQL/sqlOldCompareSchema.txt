/*
Deployment script for EduXpressDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.


replace SQLCMD variables with actual name
replace GO with ;
*/

;
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


;
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'EduXpressDB')
    BEGIN
        ALTER DATABASE [EduXpressDB]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


;
USE [EduXpressDB];


;
ALTER TABLE [dbo].[Students] DROP CONSTRAINT [FK_Students_AcademicYear];





;
ALTER TABLE [dbo].[Discount] DROP CONSTRAINT [FK_Discount_Students];




;
ALTER TABLE [dbo].[CourseFeePayment] DROP CONSTRAINT [FK_CourseFeePayment_Students];




;
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Students] (
    [StudentID]          INT            IDENTITY (1, 1) NOT NULL,
    [StudentNumber]      NVARCHAR (50)  NOT NULL,
    [Section]            NVARCHAR (50)  NULL,
    [EnrolmentDate]      DATE           NOT NULL,
    [Class]              NVARCHAR (50)  NOT NULL,
    [StudentSurname]     NVARCHAR (60)  NOT NULL,
    [StudentFirstNames]  NVARCHAR (60)  NOT NULL,
    [Gender]             NVARCHAR (50)  NOT NULL,
    [DateBirth]          DATE           NULL,
    [Age]                NVARCHAR (50)  NULL,
    [Nationality]        NVARCHAR (50)  NULL,
    [LastSchoolAttended] NVARCHAR (50)  NULL,
    [LastSchoolResult]   NVARCHAR (50)  NULL,
    [PassPercentage]     NVARCHAR (50)  NULL,
    [StudentEmail]       NVARCHAR (100) NULL,
    [StudentPhoneNumber] NVARCHAR (50)  NULL,
    [HomeLanguage]       NVARCHAR (100) NULL,
    [Religion]           NVARCHAR (100) NULL,
    [MedicalAllergies]   NVARCHAR (150) NULL,
    [StudentSibling]     NVARCHAR (50)  NULL,
    [SiblingsNo]         TINYINT        NULL,
    [DocumentSubmitted]  TINYINT        NULL,
    [FatherSurname]      NVARCHAR (100) NULL,
    [FatherNames]        NVARCHAR (100) NULL,
    [FatherContactNo]    NVARCHAR (50)  NULL,
    [FatherEmail]        NVARCHAR (100) NULL,
    [NotificationNo]     NVARCHAR (50)  NULL,
    [NotificationEmail]  NVARCHAR (100) NULL,
    [MotherSurname]      NVARCHAR (100) NULL,
    [MotherNames]        NVARCHAR (100) NULL,
    [MotherContactNo]    NVARCHAR (50)  NULL,
    [MotherEmail]        NVARCHAR (100) NULL,
    [HomeAddress]        NVARCHAR (200) NULL,
    [EmergencyPhoneNo]   NVARCHAR (50)  NULL,
    [AbsencePhoneNo]     NVARCHAR (50)  NULL,
    [SchoolActivities]   NVARCHAR (50)  NULL,
    [SchoolPhotos]       NVARCHAR (50)  NULL,
    [SchoolYear]         NVARCHAR (50)  NOT NULL,
    [Cycle]              NVARCHAR (50)  NOT NULL,
    [TutorName]          NVARCHAR (100) NULL,
    [TutorProfession]    NVARCHAR (100) NULL,
    [FatherProfession]   NVARCHAR (100) NULL,
    [MotherProfession]   NVARCHAR (100) NULL,
    [Disabilities]       NVARCHAR (200) NULL,
    [StudentPicture]     IMAGE          NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_Students1] PRIMARY KEY CLUSTERED ([StudentID] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_IX_Students1] UNIQUE NONCLUSTERED ([StudentNumber] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Students])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Students] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Students] ([StudentID], [StudentNumber], [Section], [EnrolmentDate], [Class], [StudentSurname], [StudentFirstNames], [Gender], [DateBirth], [Age], [Nationality], [LastSchoolAttended], [LastSchoolResult], [PassPercentage], [StudentEmail], [StudentPhoneNumber], [HomeLanguage], [Religion], [MedicalAllergies], [StudentSibling], [SiblingsNo], [DocumentSubmitted], [FatherSurname], [FatherNames], [FatherContactNo], [FatherEmail], [NotificationNo], [NotificationEmail], [MotherSurname], [MotherNames], [MotherContactNo], [MotherEmail], [HomeAddress], [EmergencyPhoneNo], [AbsencePhoneNo], [SchoolActivities], [SchoolPhotos], [SchoolYear], [Cycle], [TutorName], [TutorProfession], [FatherProfession], [MotherProfession], [StudentPicture])
        SELECT   [StudentID],
                 [StudentNumber],
                 [Section],
                 [EnrolmentDate],
                 [Class],
                 [StudentSurname],
                 [StudentFirstNames],
                 [Gender],
                 [DateBirth],
                 [Age],
                 [Nationality],
                 [LastSchoolAttended],
                 [LastSchoolResult],
                 [PassPercentage],
                 [StudentEmail],
                 [StudentPhoneNumber],
                 [HomeLanguage],
                 [Religion],
                 [MedicalAllergies],
                 [StudentSibling],
                 [SiblingsNo],
                 [DocumentSubmitted],
                 [FatherSurname],
                 [FatherNames],
                 [FatherContactNo],
                 [FatherEmail],
                 [NotificationNo],
                 [NotificationEmail],
                 [MotherSurname],
                 [MotherNames],
                 [MotherContactNo],
                 [MotherEmail],
                 [HomeAddress],
                 [EmergencyPhoneNo],
                 [AbsencePhoneNo],
                 [SchoolActivities],
                 [SchoolPhotos],
                 [SchoolYear],
                 [Cycle],
                 [TutorName],
                 [TutorProfession],
                 [FatherProfession],
                 [MotherProfession],
                 [StudentPicture]
        FROM     [dbo].[Students]
        ORDER BY [StudentID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Students] OFF;
    END

DROP TABLE [dbo].[Students];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Students]', N'Students';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_Students1]', N'PK_Students', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_IX_Students1]', N'IX_Students', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;





;
ALTER TABLE [dbo].[Students] WITH NOCHECK
    ADD CONSTRAINT [FK_Students_AcademicYear] FOREIGN KEY ([SchoolYear]) REFERENCES [dbo].[AcademicYear] ([SchoolYear]) ON UPDATE CASCADE;




;
ALTER TABLE [dbo].[Discount] WITH NOCHECK
    ADD CONSTRAINT [FK_Discount_Students] FOREIGN KEY ([StudentID]) REFERENCES [dbo].[Students] ([StudentID]);





;
ALTER TABLE [dbo].[CourseFeePayment] WITH NOCHECK
    ADD CONSTRAINT [FK_CourseFeePayment_Students] FOREIGN KEY ([StudentNumber]) REFERENCES [dbo].[Students] ([StudentNumber]) ON DELETE CASCADE ON UPDATE CASCADE;





;
USE [EduXpressDB];


;
ALTER TABLE [dbo].[Students] WITH CHECK CHECK CONSTRAINT [FK_Students_AcademicYear];

ALTER TABLE [dbo].[Discount] WITH CHECK CHECK CONSTRAINT [FK_Discount_Students];

ALTER TABLE [dbo].[CourseFeePayment] WITH CHECK CHECK CONSTRAINT [FK_CourseFeePayment_Students];




;